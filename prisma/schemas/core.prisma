// ============================================================================
// CORE MODULE - Company & User Management
// Foundation models for multi-company, multi-branch, multi-user
// ============================================================================
// Models: Perusahaan, PengaturanPerusahaan, Cabang, Pengguna, MataUang, KursHistory
// Purpose: Company setup, user management, multi-currency
// ============================================================================

model MataUang {
    id           String @id @default(cuid())
    kode         String @unique // "IDR", "USD", "SGD", "EUR"
    nama         String
    simbol       String
    desimalDigit Int    @default(2)

    negara String?

    isAktif   Boolean @default(true)
    isDefault Boolean @default(false)

    kursHistory        KursHistory[]
    transaksi          Transaksi[]
    pembayaranPiutangs PembayaranPiutang[] @relation("MataUangToPembayaranPiutang")
    pembayaranHutangs  PembayaranHutang[]  @relation("MataUangToPembayaranHutang")

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([kode, isAktif])
}

model KursHistory {
    id         String   @id @default(cuid())
    mataUang   MataUang @relation(fields: [mataUangId], references: [id])
    mataUangId String

    tanggal  DateTime
    kurs     Decimal  @db.Decimal(18, 6) // Kurs tengah
    kursBeli Decimal? @db.Decimal(18, 6)
    kursJual Decimal? @db.Decimal(18, 6)

    sumber String? // "BI", "Manual", "API_XE", "API_CURRENCYAPI"

    createdAt DateTime @default(now())

    @@unique([mataUangId, tanggal])
    @@index([mataUangId])
    @@index([tanggal])
}

// ============================================================================
// CORE MODELS
// ============================================================================

model Perusahaan {
    id               String           @id @default(cuid())
    kode             String           @unique
    nama             String
    deskripsi        String?
    onboardingStatus OnboardingStatus @default(PENDING)
    isPusat          Boolean          @default(true)
    namaLengkap      String?
    bentukUsaha      String?
    bidangUsaha      String?
    alamat           String?
    kelurahan        String?
    kecamatan        String?
    kota             String?
    provinsi         String?
    kodePos          String?
    telepon          String?
    fax              String?
    email            String?
    website          String?

    npwp          String?
    nib           String?
    aktaPendirian String?
    skKemenkumham String?

    logo             String?
    mataUangUtama    String  @default("IDR")
    tahunBuku        Int     @default(12)
    bulanMulaiFiskal Int     @default(1) // 1 = Januari
    satuanUsahaKecil Boolean @default(false)

    induk   Perusahaan?  @relation("GrupPerusahaan", fields: [indukId], references: [id])
    indukId String?
    anak    Perusahaan[] @relation("GrupPerusahaan")

    cabang            Cabang[]
    aksesPengguna     AksesPengguna[]
    coa               ChartOfAccounts[]
    transaksi         Transaksi[]
    voucher           Voucher[]
    jurnal            JurnalUmum[]
    asetTetap         AsetTetap[]
    asetTidakBerwujud AsetTidakBerwujud[]
    persediaan        Persediaan[]
    pajak             MasterPajak[]
    pelanggan         Pelanggan[]
    pemasok           Pemasok[]
    karyawan          Karyawan[]
    costCenter        CostCenter[]
    profitCenter      ProfitCenter[]
    kontrak           Kontrak[]
    bankRekening      BankRekening[]
    laporan           Laporan[]
    budget            Budget[]
    departemen        Departemen[]
    proyek            Proyek[]
    piutang           Piutang[]
    hutang            Hutang[]
    fakturPajak       FakturPajak[]
    laporanPajak      LaporanPajak[]

    createdAt            DateTime              @default(now())
    updatedAt            DateTime              @updatedAt
    roles                Role[]
    undanganPenggunas    UndanganPengguna[]
    periodeAkuntansis    PeriodeAkuntansi[]
    pengaturanPerusahaan PengaturanPerusahaan?
    transaksiRekurens    TransaksiRekuren[]
    approvalTemplates    ApprovalTemplate[]
    jejakAudits          JejakAudit[]
    produks              Produk[]
    dashboardWidgets     DashboardWidget[]
    perusahaanPakets     PerusahaanPaket[]
    dokumenTransaksi     DokumenTransaksi[]
    payrolls             Penggajian[]          @relation("PerusahaanPayrolls")
    proyekTransaksis     ProyekTransaksi[]
    subscriptionRequests SubscriptionRequest[]

    @@index([kode])
    @@index([npwp])
}

model PengaturanPerusahaan {
    id           String     @id @default(cuid())
    perusahaan   Perusahaan @relation(fields: [perusahaanId], references: [id], onDelete: Cascade)
    perusahaanId String     @unique

    metodeAkuntansi  String                    @default("ACCRUAL")
    metodeInventory  MetodePenilaianPersediaan @default(RATA_RATA_BERGERAK)
    metodePenyusutan MetodePenyusutan          @default(GARIS_LURUS)
    metodAmortisasi  MetodePenyusutan          @default(GARIS_LURUS)

    // Akun Linkage untuk Closing (PSAK)
    akunLabaTahunBerjalanId String?
    akunLabaDitahanId       String?

    batasKreditDefault    Decimal @default(0) @db.Decimal(18, 2)
    termPembayaranDefault Int     @default(30)

    permitEditTransaksiPosted   Boolean @default(false)
    permitDeleteTransaksiPosted Boolean @default(false)
    requireApprovalVoucher      Boolean @default(true)
    requireApprovalPembayaran   Boolean @default(true)

    autoNumberingVoucher Boolean @default(true)
    formatNomorVoucher   String  @default("[PREFIX]-[YEAR][MONTH]-[SEQUENCE]")

    autoNumberingInvoice Boolean @default(true)
    formatNomorInvoice   String  @default("INV-[YEAR][MONTH]-[SEQUENCE]")

    useMultiCurrency  Boolean @default(false)
    useMultiWarehouse Boolean @default(false)
    useCostCenter     Boolean @default(false)
    useProfitCenter   Boolean @default(false)
    useProjectCosting Boolean @default(false)
    useBudgeting      Boolean @default(false)

    notifikasiEmail    Boolean @default(true)
    notifikasiWhatsapp Boolean @default(false)

    backupOtomatis   Boolean @default(true)
    frekuensiBackup  String  @default("HARIAN")
    retensiBukuBesar Int     @default(7) // tahun

    integrasiPajak Boolean @default(false)
    apiKeyEfaktur  String?
    apiKeyEbupot   String?

    logoKopSurat     String?
    templateKopSurat Json?

    customSettings Json?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model Cabang {
    id           String     @id @default(cuid())
    perusahaan   Perusahaan @relation(fields: [perusahaanId], references: [id])
    perusahaanId String

    kode    String
    nama    String
    alamat  String?
    kota    String?
    telepon String?
    email   String?

    kepala   String?
    isAktif  Boolean @default(true)
    isKantor Boolean @default(false)

    aksesPengguna AksesPengguna[]
    transaksi     Transaksi[]
    vouchers      Voucher[]
    jurnals       JurnalUmum[]
    gudang        Gudang[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([perusahaanId, kode])
    @@index([perusahaanId])
}

model Pengguna {
    id String @id @default(cuid())

    username String @unique
    email    String @unique
    password String

    namaLengkap String

    foto    String?
    telepon String?

    isAktif           Boolean   @default(true)
    emailVerified     Boolean   @default(false)
    lastLogin         DateTime?
    passwordChangedAt DateTime? @default(now())

    // Security Hardening
    failedLoginAttempts Int       @default(0)
    lockoutUntil        DateTime?

    aksesModul  Json? // {"inventory": true, "payroll": false} (Global/Default)
    permissions Json? // Global permissions

    voucher          Voucher[]
    transaksi        Transaksi[]
    laporan          Laporan[]
    approval         ApprovalFlow[]
    notifikasi       Notifikasi[]
    jejakAudit       JejakAudit[]
    dashboardWidgets DashboardWidget[]
    uploadedDocs     DokumenTransaksi[]

    // Multi-Tenant Access
    aksesPerusahaan AksesPengguna[]
    invitationsSent UndanganPengguna[] @relation("UserInvitations")

    // Security Hardening Relations
    refreshTokens     RefreshToken[]
    passwordHistories PasswordHistory[]

    // Subscription relations
    subscriptionRequests  SubscriptionRequest[] @relation("Requester")
    approvedSubscriptions SubscriptionRequest[] @relation("Approver")

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([email])
}

model Role {
    id          String  @id @default(cuid())
    name        String // ADMIN, MANAGER, ACCOUNTANT, etc
    displayName String // "Administrator", "Manajer", etc
    description String?

    // Permissions for this role
    permissions Permission[]

    // Role hierarchy
    level Int @default(0) // 0=highest (superadmin), 5=lowest (staff)

    // Can this role assign other roles?
    canAssignRoles  Boolean  @default(false)
    assignableRoles String[] // Array of role IDs or names they can assign

    // System vs Custom
    isSystemRole Boolean     @default(true) // Cannot delete system roles
    companyId    String?
    company      Perusahaan? @relation(fields: [companyId], references: [id])

    aksesPengguna AksesPengguna[]
    invitations   UndanganPengguna[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([companyId, name])
    @@index([companyId])
}

model UndanganPengguna {
    id String @id @default(cuid())

    perusahaanId String
    perusahaan   Perusahaan @relation(fields: [perusahaanId], references: [id], onDelete: Cascade)

    email  String
    roleId String
    role   Role   @relation(fields: [roleId], references: [id])

    invitedBy String
    inviter   Pengguna @relation("UserInvitations", fields: [invitedBy], references: [id])

    token     String   @unique
    expiresAt DateTime

    acceptedAt DateTime?
    acceptedBy String?

    message String? // Optional invitation message

    createdAt DateTime @default(now())

    @@index([perusahaanId])
    @@index([email])
    @@index([token])
}

model AksesPengguna {
    id           String     @id @default(cuid())
    pengguna     Pengguna   @relation(fields: [penggunaId], references: [id], onDelete: Cascade)
    penggunaId   String
    perusahaan   Perusahaan @relation(fields: [perusahaanId], references: [id], onDelete: Cascade)
    perusahaanId String
    cabang       Cabang?    @relation(fields: [cabangId], references: [id])
    cabangId     String?

    // Deprecated: use roleId instead. Kept for migration safety.
    roleEnum UserRole @default(STAFF) @map("role")

    roleId  String?
    roleRef Role?   @relation(fields: [roleId], references: [id])

    isAktif   Boolean @default(true)
    isDefault Boolean @default(false)

    // Per-company permissions/access (Overrides Role permissions if needed - Advanced)
    aksesModul  Json?
    permissions Json?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([penggunaId, perusahaanId])
    @@index([penggunaId])
    @@index([perusahaanId])
    @@index([cabangId])
    @@index([roleId])
}
